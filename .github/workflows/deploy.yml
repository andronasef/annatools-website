# https://github.com/actions/deploy-pages#usage
name: Deploy to Cloudflare Pages
on:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  create-envfile:
    runs-on: ubuntu-latest
    steps:
    - name: Make envfile
      uses: SpicyPizza/create-envfile@v2.0
      with:
        envkey_NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        envkey_BLOG_DATABASE_ID: ${{ secrets.BLOG_DATABASE_ID }}
        envkey_TOOLS_CONTENT_DATABASE_ID: ${{ secrets.TOOLS_CONTENT_DATABASE_ID }}


  build:
    needs: create-envfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: "andronasef/annatools"
          token: ${{ secrets.GH_PAT }}
      - name: List files in the repository
        run: |
            ls .
      - run: corepack enable
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bunx nuxt generate
      
      # - uses: actions/checkout@v4
      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .output/public --project-name=annatools

  #     # - name: Upload artifact
  #       # uses: actions/upload-pages-artifact@v1
  #       # with:
  #       #   path: ./.output/public


  # deploy:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   name: Deploy
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Deploy
  #       uses: cloudflare/wrangler-action@v3
  #       with:
  #         apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  #         accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  #         command: pages deploy .output/public --project-name=annatools

  #       # with:.
  #       #   apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  #       #   workingDirectory: "/.output/public"

      
  # # # Deployment job
  # # deploy:
  # #   # Add a dependency to the build job
  # #   needs: build
  # #   # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
  # #   permissions:
  # #     pages: write      # to deploy to Pages
  # #     id-token: write   # to verify the deployment originates from an appropriate source
  # #   # Deploy to the github_pages environment
  # #   environment:
  # #     name: github_pages
  # #     url: ${{ steps.deployment.outputs.page_url }}
  # #   # Specify runner + deployment step
  # #   runs-on: ubuntu-latest
  # #   steps:
  # #     - name: Deploy to GitHub Pages
  # #       id: deployment
  # #       uses: actions/deploy-pages@v1
 
  # # unlighthouse:
  # #   # # Add a dependency to the build job
  # #   # needs: deploy
  # #   # # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
  # #   # permissions:
  # #   #   pages: write      # to deploy to Pages
  # #   #   id-token: write   # to verify the deployment originates from an appropriate source
  # #   # # Deploy to the github_pages environment
  # #   # environment:
  # #   #   name: github_pages
  # #   #   url: ${{ steps.deployment.outputs.page_url }}
  # #   # # Specify runner + deployment step
  # #   runs-on: ubuntu-latest
  # #   steps:
  # #     - uses: oven-sh/setup-bun@v1
  # #     - name: Install Dependencies
  # #       run: bun install -g @unlighthouse/cli puppeteer netlify-cli
        

  # #     - name: Unlighthouse assertions and client
  # #       run: unlighthouse-ci --site annatools.me --budget 75 --build-static

  #     # - name: Deploy
  #     #   run: netlify deploy --dir=.unlighthouse --prod --message="New Release Deploy from GitHub Actions"
  #     #   env:
  #     #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
  #     #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
